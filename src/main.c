#include <stdio.h>
#include <stdlib.h>

typedef unsigned char u8;
typedef unsigned short u16;
typedef unsigned long u64;

#define hasbits(b, m) ((b) & (m)) == (m)
#define getbits(b, m) (b) & (m)

u8* stream;

typedef struct reg {
    union{
        u16 x;
        struct{
            u8 h,l;
        };
    };
} reg;

struct{
    reg a,b,c,d;
    reg sp,bp,si,di;
}registers;

u16* get_reg16(u8 r) {
    switch(r) {
        case 0b000: return &registers.a.x;
        case 0b001: return &registers.b.x;
        case 0b010: return &registers.c.x;
        case 0b011: return &registers.d.x;
        case 0b100: return &registers.sp.x;
        case 0b101: return &registers.bp.x;
        case 0b110: return &registers.si.x;
        case 0b111: return &registers.di.x;
    }
}

u8* get_reg8(u8 r) {
    switch(r) {
        case 0b000: return &registers.a.l;
        case 0b001: return &registers.b.l;
        case 0b010: return &registers.c.l;
        case 0b011: return &registers.d.l;
        case 0b100: return &registers.a.h;
        case 0b101: return &registers.b.h;
        case 0b110: return &registers.c.h;
        case 0b111: return &registers.d.h;
    }
}

u16 get_value16() {
    u8 low = *(++stream);
    u8 high = *(++stream);
    return ((u16)high) << 8 | (u16)low;
}

u8 get_value8() {
    return *(++stream);
}

void mov_regmem_tf_reg() {
    u8 byte = *stream;
    u8 d = hasbits(byte, 0b00000010);
    u8 w = hasbits(byte, 0b00000001);
    u8 byte2 = *(++stream);
    u8 mode = getbits(byte2, 0b11000000) >> 6;
    switch(mode) {
        case 0b00:
        case 0b01:
        case 0b10:{
            u8 rm = getbits(byte2, 0b00000111);
            if(rm == 0b110 && mode == 0b00) {
                if(w) {

                }
                break;
            }
        }break; 

    }

}

void mov_imm_to_regmem() {
    __debugbreak();
}

void mov_imm_to_reg() {
    __debugbreak();
}

void mov_mem_to_acc() {
    __debugbreak();
}

void mov_acc_to_mem() {
    __debugbreak();
}

void mov_regmem_to_seg() {
    __debugbreak();
}

void mov_seg_to_regmem() {
    __debugbreak();
}

void push_inc_dec_call_jmp_regmem() {
    __debugbreak();
}

void push_reg() {
    __debugbreak();
}

void push_seg() {
    __debugbreak();
}

void pop_regmem() {
    __debugbreak();
}

void pop_reg() {
    __debugbreak();
}

void pop_seg() {
    __debugbreak();
}

void xchg_regmem_w_reg() {
    __debugbreak();
}

void xchg_reg_w_acc() {
    __debugbreak();
}

void in_fixed() {
    __debugbreak();
}

void in_variable() {
    __debugbreak();
}

void out_fixed() {
    __debugbreak();
}

void out_variable() {
    __debugbreak();
}

void out_xlat() {
    __debugbreak();
}

void out_lea() {
    __debugbreak();
}

void out_lds() {
    __debugbreak();
}

void out_les() {
    __debugbreak();
}

void out_lahf() {
    __debugbreak();
}

void out_sahf() {
    __debugbreak();
}

void out_pushf() {
    __debugbreak();
}

void out_popf() {
    __debugbreak();
}

void add_regmem_w_reg_to_either() {
    __debugbreak();
}

void add_adc_sub_sbb_cmp_and_or_imm_to_regmem() {
    __debugbreak();
}

void add_imm_to_acc() {
    __debugbreak();
}

void adc_regmem_w_reg_to_either() {
    __debugbreak();
}

void adc_imm_to_acc() {
    __debugbreak();
}

void inc_regmem() {
    __debugbreak();
}

void inc_reg() {
    __debugbreak();
}

void inc_aaa() {
    __debugbreak();
}

void inc_daa() {
    __debugbreak();
}

void sub_regmem_and_reg_to_either() {
    __debugbreak();
}

void sub_or_sbb_imm_from_regmem() {
    __debugbreak();
}

void sub_imm_from_acc() {
    __debugbreak();
}

void sbb_regmem_from_reg_to_either() {
    __debugbreak();
}

void sbb_imm_from_acc() {
    __debugbreak();
}

void dec_reg() {
    __debugbreak();
}

void neg_mul_div_not_test() {
    __debugbreak();
}

void cmp_regmem_and_reg() {
    __debugbreak();
}

void cmp_imm_and_acc() {
    __debugbreak();
}

void cmp_aas() {
    __debugbreak();
}

void cmp_das() {
    __debugbreak();
}

void cmp_aam() {
    __debugbreak();
}

void cmp_aad() {
    __debugbreak();
}

void cmp_cbw() {
    __debugbreak();
}

void cmp_cwd() {
    __debugbreak();
}

void not() {
    __debugbreak();
}

void shl_sal_shr_sar_rol_ror_rcl_rcr() {
    __debugbreak();
}

void and_regmem_with_reg_to_either() {
    __debugbreak();
}

void and_imm_to_acc() {
    __debugbreak();
}

void test_regmem_and_reg() {
    __debugbreak();
}

void test_imm_and_acc() {
    __debugbreak();
}

void xor_regmem_and_reg_to_either() {
    __debugbreak();
}

void xor_imm_to_regmem_or_acc() {
    __debugbreak();
}

void str_rep() {
    __debugbreak();
}

void str_movs() {
    __debugbreak();
}

void str_cmps() {
    __debugbreak();
}

void str_scas() {
    __debugbreak();
}

void str_lods() {
    __debugbreak();
}

void str_stds() {
    __debugbreak();
}

void call_direct_within_segment() {
    __debugbreak();
}

void call_indirect_within_segment() {
    __debugbreak();
}

void call_direct_intersegment() {
    __debugbreak();
}

void call_indirect_intersegment() {
    __debugbreak();
}

void jmp_direct_within_segment() {
    __debugbreak();
}

void jmp_direct_within_segment_short() {
    __debugbreak();
}

void jmp_direct_intersegment() {
    __debugbreak();
}

void ret_within_segment() {
    __debugbreak();
}

void ret_within_segment_add_imm_to_sp() {
    __debugbreak();
}

void ret_intersegment() {
    __debugbreak();
}

void ret_intersegment_add_imm_to_sp() {
    __debugbreak();
}

// NOTE(sushi) the jump opcodes expect the  to have been incremented already
void je_jz() {
    __debugbreak();
}

void jl_jnge() {
    __debugbreak();
}

void jle_jng() {
    __debugbreak();
}

void jb_jnae() {
    __debugbreak();
}

void jbe_jna() {
    __debugbreak();
}

void jp_jpe() {
    __debugbreak();
}

void jo() {
    __debugbreak();
}

void js() {
    __debugbreak();
}

void jne_jnz() {
    __debugbreak();
}

void jnl_jge() {
    __debugbreak();
}

void jnle_jg() {
    __debugbreak();
}

void jnb_jae() {
    __debugbreak();
}

void jnbe_ja() {
    __debugbreak();
}

void jnp_jpo() {
    __debugbreak();
}

void jno() {
    __debugbreak();
}

void jns() {
    __debugbreak();
}

void loop_() {
    __debugbreak();
}

void loopz_loope() {
    __debugbreak();
}

void loopnz_loopne() {
    __debugbreak();
}

void jcxz() {
    __debugbreak();
}

void interrupt_typed() {
    __debugbreak();
}

void interrupt_type_3() {
    __debugbreak();
}

void interrupt_on_overflow() {
    __debugbreak();
}

void interrupt_return() {
    __debugbreak();
}

void clear_carry() {
    __debugbreak();
}

void complement_carry() {
    __debugbreak();
}

void set_carry() {
    __debugbreak();
}

void clear_direction() {
    __debugbreak();
}

void set_direction() {
    __debugbreak();
}

void clear_interrupt() {
    __debugbreak();
}

void set_interrupt() {
    __debugbreak();
}

void halt() {
    __debugbreak();
}

void wait() {
    __debugbreak();
}

void esc() {
    __debugbreak();
} 

void lock() {
    __debugbreak();
}

void segment() {
    __debugbreak();
}

void decode() {
    u8 byte = *stream;
    u8 
    b0 = (byte >> 7) & 1,
    b1 = (byte >> 6) & 1,
    b2 = (byte >> 5) & 1,
    b3 = (byte >> 4) & 1,
    b4 = (byte >> 3) & 1,
    b5 = (byte >> 2) & 1,
    b6 = (byte >> 1) & 1,
    b7 = (byte >> 0) & 1;

    if(b0) { // ------------------------------------------------------------- 1xxxxxxx
        if(b1) { // --------------------------------------------------------- 11xxxxxx
            if(b2) { // ----------------------------------------------------- 111xxxxx
                if(b3) { // ------------------------------------------------- 1111xxxx
                    if(b4) { // --------------------------------------------- 11111xxx
                        if(b5) { // ----------------------------------------- 111111xx
                            if(b6) { // ------------------------------------- 1111111x
                                push_inc_dec_call_jmp_regmem();
                            } else { // ------------------------------------ 1111110x
                                if(b7) { // --------------------------------- 11111101
                                    set_direction();
                                } else { // -------------------------------- 11111100
                                    clear_direction();
                                }
                            }
                        } else { // ---------------------------------------- 111110xx
                            if(b6) { // ------------------------------------- 1111101x
                                if(b7) { // --------------------------------- 11111011
                                    set_interrupt();
                                } else { // -------------------------------- 11111010
                                    clear_interrupt();
                                }
                            } else { // ------------------------------------ 1111100x
                                if(b7) { // --------------------------------- 11111001
                                    set_carry();
                                } else { // -------------------------------- 11111000
                                    clear_carry();
                                }
                            }
                        }
                    } else { // -------------------------------------------- 11110xxx
                        if(b5) { // ----------------------------------------- 111101xx
                            if(b6) { // ------------------------------------- 1111011x
                                neg_mul_div_not_test();
                            } else { // ------------------------------------ 1111010x
                                if(b7) { // --------------------------------- 11110101
                                    complement_carry();
                                } else { // -------------------------------- 11110100
                                    halt();
                                }
                            }
                        } else { // ---------------------------------------- 111100xx
                            if(b6) { // ------------------------------------- 1111001x
                                if(b7) { // --------------------------------- 11110011
                                    str_rep();
                                } else { // -------------------------------- 11110010
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 1111000x
                                if(b7) { // --------------------------------- 11110001
                                    __debugbreak();
                                } else { // -------------------------------- 11110000
                                    lock();
                                }
                            }
                        }
                    }
                } else { // ------------------------------------------------ 1110xxxx
                    if(b4) { // --------------------------------------------- 11101xxx
                        if(b5) { // ----------------------------------------- 111011xx
                            if(b6) { // ------------------------------------- 1110111x
                                out_variable();
                            } else { // ------------------------------------ 1110110x
                                in_variable();
                            }
                        } else { // ---------------------------------------- 111010xx
                            if(b6) { // ------------------------------------- 1110101x
                                if(b7) { // --------------------------------- 11101011
                                    jmp_direct_within_segment_short();
                                } else { // -------------------------------- 11101010
                                    jmp_direct_intersegment();
                                }
                            } else { // ------------------------------------ 1110100x
                                if(b7) { // --------------------------------- 11101001
                                    jmp_direct_within_segment();
                                } else { // -------------------------------- 11101000
                                    call_direct_within_segment();
                                }
                            }
                        }
                    } else { // -------------------------------------------- 11100xxx
                        if(b5) { // ----------------------------------------- 111001xx
                            if(b6) { // ------------------------------------- 1110011x
                                out_fixed();
                            } else { // ------------------------------------ 1110010x
                                in_fixed();
                            }
                        } else { // ---------------------------------------- 111000xx
                            if(b6) { // ------------------------------------- 1110001x
                                if(b7) { // --------------------------------- 11100011
                                    jcxz();
                                } else { // -------------------------------- 11100010
                                    loop_();
                                }
                            } else { // ------------------------------------ 1110000x
                                if(b7) { // --------------------------------- 11100001
                                    loopz_loope();
                                } else { // -------------------------------- 11100000
                                    loopnz_loopne();
                                }
                            }
                        }
                    }
                }
            } else { // ---------------------------------------------------- 110xxxxx
                if(b3) { // ------------------------------------------------- 1101xxxx
                    if(b4) { // --------------------------------------------- 11011xxx
                        esc();
                    } else { // -------------------------------------------- 11010xxx
                        if(b5) { // ----------------------------------------- 110101xx
                            if(b6) { // ------------------------------------- 1101011x
                                if(b7) { // --------------------------------- 11010111
                                    out_xlat();
                                } else { // -------------------------------- 11010110
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 1101010x
                                if(b7) { // --------------------------------- 11010101
                                    cmp_aad();
                                } else { // -------------------------------- 11010100
                                    cmp_aam();
                                }
                            }
                        } else { // ---------------------------------------- 110100xx
                            shl_sal_shr_sar_rol_ror_rcl_rcr();
                        }
                    }
                } else { // ------------------------------------------------ 1100xxxx
                    if(b4) { // --------------------------------------------- 11001xxx
                        if(b5) { // ----------------------------------------- 110011xx
                            if(b6) { // ------------------------------------- 1100111x
                                if(b7) { // --------------------------------- 11001111
                                    interrupt_return();
                                } else { // -------------------------------- 11001110
                                    interrupt_on_overflow();
                                }
                            } else { // ------------------------------------ 1100110x
                                if(b7) { // --------------------------------- 11001101
                                    interrupt_typed();
                                } else { // -------------------------------- 11001100
                                    interrupt_type_3();
                                }
                            }
                        } else { // ---------------------------------------- 110010xx
                            if(b6) { // ------------------------------------- 1100101x
                                if(b7) { // --------------------------------- 11001011
                                    ret_intersegment();
                                } else { // -------------------------------- 11001010
                                    ret_intersegment_add_imm_to_sp();
                                }
                            } else { // ------------------------------------ 1100100x
                                if(b7) { // --------------------------------- 11001001
                                    __debugbreak();
                                } else { // -------------------------------- 11001000
                                    __debugbreak();
                                }
                            }
                        }
                    } else { // -------------------------------------------- 11000xxx
                        if(b5) { // ----------------------------------------- 110001xx
                            if(b6) { // ------------------------------------- 1100011x --- mov: imm->reg/mem
                                mov_imm_to_regmem();
                            } else { // ------------------------------------ 1100010x
                                if(b7) { // --------------------------------- 11000101
                                    out_lds();
                                } else { // -------------------------------- 11000100
                                    out_les();
                                }
                            }
                        } else { // ---------------------------------------- 110000xx
                            if(b6) { // ------------------------------------- 1100001x
                                if(b7) { // --------------------------------- 11000011
                                    ret_within_segment();
                                } else { // -------------------------------- 11000010
                                    ret_within_segment_add_imm_to_sp();
                                }
                            } else { // ------------------------------------ 1100000x
                                if(b7) { // --------------------------------- 11000001
                                    __debugbreak();
                                } else { // -------------------------------- 11000000
                                    __debugbreak();
                                }
                            }
                        }
                    }
                }
            }
        } else { // -------------------------------------------------------- 10xxxxxx
            if(b2) { // ----------------------------------------------------- 101xxxxx
                if(b3) { // ------------------------------------------------- 1011xxxx --- mov: imm->reg
                    mov_imm_to_reg();
                } else { // ------------------------------------------------ 1010xxxx
                    if(b4) { // --------------------------------------------- 10101xxx
                        if(b5) { // ----------------------------------------- 101011xx
                            if(b6) { // ------------------------------------- 1010111x
                                str_scas();
                            } else { // ------------------------------------ 1010110x
                                str_lods();
                            }
                        } else { // ---------------------------------------- 101010xx
                            if(b6) { // ------------------------------------- 1010101x
                                str_stds();
                            } else { // ------------------------------------ 1010100x
                                test_imm_and_acc();
                            }
                        }
                    } else { // -------------------------------------------- 10100xxx
                        if(b5) { // ----------------------------------------- 101001xx
                            if(b6) { // ------------------------------------- 1010011x
                                str_cmps();
                            } else { // ------------------------------------ 1010010x
                                str_movs();
                            }
                        } else { // ---------------------------------------- 101000xx
                            if(b6) { // ------------------------------------- 1010001x --- mov: acc->mem
                                mov_acc_to_mem();
                            } else { // ------------------------------------ 1010000x --- mov: mem->acc
                                mov_mem_to_acc();
                            }
                        }
                    }
                }
            } else { // ---------------------------------------------------- 100xxxxx
                if(b3) { // ------------------------------------------------- 1001xxxx
                    if(b4) { // --------------------------------------------- 10011xxx
                        if(b5) { // ----------------------------------------- 100111xx
                            if(b6) { // ------------------------------------- 1001111x
                                if(b7) { // --------------------------------- 10011111
                                    out_lahf();
                                } else { // -------------------------------- 10011110
                                    out_sahf();
                                }
                            } else { // ------------------------------------ 1001110x
                                if(b7) { // --------------------------------- 10011101
                                    out_popf();
                                } else { // -------------------------------- 10011100
                                    out_pushf();
                                }
                            }
                        } else { // ---------------------------------------- 100110xx
                            if(b6) { // ------------------------------------- 1001101x
                                if(b7) { // --------------------------------- 10011011
                                    wait();
                                } else { // -------------------------------- 10011010
                                    call_direct_intersegment();
                                }
                            } else { // ------------------------------------ 1001100x
                                if(b7) { // --------------------------------- 10011001
                                    cmp_cwd();
                                } else { // -------------------------------- 10011000
                                    cmp_cbw();
                                }
                            }
                        }
                    } else { // -------------------------------------------- 10010xxx
                        xchg_reg_w_acc();
                    }
                } else {  // ------------------------------------------------ 1000xxxx
                    if(b4) { // --------------------------------------------- 10001xxx
                        if(b5) { // ----------------------------------------- 100011xx
                            if(b6) { // ------------------------------------- 1000111x
                                if(b7) { // --------------------------------- 10001111
                                    pop_regmem();
                                } else { // -------------------------------- 10001110 --- mov: reg/mem->seg
                                    mov_regmem_to_seg();
                                }   
                            } else {  // ------------------------------------ 1000110x
                                if(b7) { // --------------------------------- 10001101
                                    out_lea();
                                } else { // -------------------------------- 10001100 --- mov: seg->reg/mem
                                    mov_seg_to_regmem();
                                }
                            }
                        } else { // ---------------------------------------- 100010xx --- mov: reg/mem<->reg
                            mov_regmem_tf_reg();
                        }
                    } else {  // -------------------------------------------- 10000xxx
                        if(b5) { // ----------------------------------------- 100001xx
                            if(b6) { // ------------------------------------- 1000011x
                                xchg_regmem_w_reg();
                            } else {  // ------------------------------------ 1000010x
                                if(b7) { // --------------------------------- 10000101
                                    __debugbreak();
                                } else {  // -------------------------------- 10000100
                                    __debugbreak();
                                }
                            }
                        } else { // ---------------------------------------- 100000xx 
                            add_adc_sub_sbb_cmp_and_or_imm_to_regmem();
                        }
                    }
                }
            }
        }
    } else {  // ------------------------------------------------------------ 0xxxxxxx
        if(b1) { // --------------------------------------------------------- 01xxxxxx
            if(b2) { // ----------------------------------------------------- 011xxxxx
                if(b3) { // ------------------------------------------------- 0111xxxx
                    if(b4) { // --------------------------------------------- 01111xxx
                        if(b5) { // ----------------------------------------- 011111xx
                            if(b6) { // ------------------------------------- 0111111x
                                if(b7) { // --------------------------------- 01111111
                                    jnle_jg();
                                } else { // -------------------------------- 01111110
                                    jle_jng();
                                }
                            } else { // ------------------------------------ 0111110x
                                if(b7) { // --------------------------------- 01111101
                                    __debugbreak();
                                } else { // -------------------------------- 01111100
                                    jl_jnge();
                                }
                            }
                        } else { // ---------------------------------------- 011110xx
                            if(b6) { // ------------------------------------- 0111101x
                                if(b7) { // --------------------------------- 01111011
                                    jnp_jpo();
                                } else { // -------------------------------- 01111010
                                    jp_jpe();
                                }
                            } else { // ------------------------------------ 0111100x
                                if(b7) { // --------------------------------- 01111001
                                    jns();
                                } else { // -------------------------------- 01111000
                                    js();
                                }
                            }
                        }
                    } else { // -------------------------------------------- 01110xxx
                        if(b5) { // ----------------------------------------- 011101xx
                            if(b6) { // ------------------------------------- 0111011x
                                if(b7) { // --------------------------------- 01110111
                                    jnbe_ja();
                                } else { // -------------------------------- 01110110
                                    jbe_jna();
                                }
                            } else { // ------------------------------------ 0111010x
                                if(b7) { // --------------------------------- 01110101
                                    jne_jnz();
                                } else { // -------------------------------- 01110100
                                    je_jz();
                                }
                            }
                        } else { // ---------------------------------------- 011100xx
                            if(b6) { // ------------------------------------- 0111001x
                                if(b7) { // --------------------------------- 01110011
                                    jnb_jae();
                                } else { // -------------------------------- 01110010
                                    jb_jnae();
                                }
                            } else { // ------------------------------------ 0111000x
                                if(b7) { // --------------------------------- 01110001
                                    jno();
                                } else { // -------------------------------- 01110000
                                    jo();
                                }
                            }
                        }
                    }
                } else { // ------------------------------------------------ 0110xxxx
                    if(b4) { // --------------------------------------------- 01101xxx
                        if(b5) { // ----------------------------------------- 011011xx
                            if(b6) { // ------------------------------------- 0110111x
                                if(b7) { // --------------------------------- 01101111
                                    __debugbreak();
                                } else { // -------------------------------- 01101110
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 0110110x
                                if(b7) { // --------------------------------- 01101101
                                    __debugbreak();
                                } else { // -------------------------------- 01101100
                                    __debugbreak();
                                }
                            }
                        } else { // ---------------------------------------- 011010xx
                            if(b6) { // ------------------------------------- 0110101x
                                if(b7) { // --------------------------------- 01101011
                                    __debugbreak();
                                } else { // -------------------------------- 01101010
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 0110100x
                                if(b7) { // --------------------------------- 01101001
                                    __debugbreak();
                                } else { // -------------------------------- 01101000
                                    __debugbreak();
                                }
                            }
                        }
                    } else { // -------------------------------------------- 01100xxx
                        if(b5) { // ----------------------------------------- 011001xx
                            if(b6) { // ------------------------------------- 0110011x
                                if(b7) { // --------------------------------- 01100111
                                    __debugbreak();
                                } else { // -------------------------------- 01100110
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 0110010x
                                if(b7) { // --------------------------------- 01100101
                                    __debugbreak();
                                } else { // -------------------------------- 01100100
                                    __debugbreak();
                                }
                            }
                        } else { // ---------------------------------------- 011000xx
                            if(b6) { // ------------------------------------- 0110001x
                                if(b7) { // --------------------------------- 01100011
                                    __debugbreak();
                                } else { // -------------------------------- 01100010
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 0110000x
                                if(b7) { // --------------------------------- 01100001
                                    __debugbreak();
                                } else { // -------------------------------- 01100000
                                    __debugbreak();
                                }
                            }
                        }
                    }
                }
            } else { // ---------------------------------------------------- 010xxxxx
                if(b3) { // ------------------------------------------------- 0101xxxx
                    if(b4) { // --------------------------------------------- 01011xxx
                        pop_reg();
                    } else { // -------------------------------------------- 01010xxx
                        push_reg();
                    }
                } else { // ------------------------------------------------ 0100xxxx
                    if(b4) { // --------------------------------------------- 01001xxx
                        dec_reg();
                    } else { // -------------------------------------------- 01000xxx
                        inc_reg();
                    }
                }
            }
        } else { // -------------------------------------------------------- 00xxxxxx
            if(b2) { // ----------------------------------------------------- 001xxxxx
                if(b3) { // ------------------------------------------------- 0011xxxx
                    if(b4) { // --------------------------------------------- 00111xxx
                        if(b5) { // ----------------------------------------- 001111xx
                            if(b6) { // ------------------------------------- 0011111x
                                if(b7) { // --------------------------------- 00111111
                                    cmp_aas();
                                } else { // -------------------------------- 00111110
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 0011110x
                                cmp_imm_and_acc();
                            }
                        } else { // ---------------------------------------- 001110xx
                            cmp_regmem_and_reg();
                        }
                    } else { // -------------------------------------------- 00110xxx
                        if(b5) { // ----------------------------------------- 001101xx
                            if(b6) { // ------------------------------------- 0011011x
                                if(b7) { // --------------------------------- 00110111
                                    inc_aaa();
                                } else { // -------------------------------- 00110110
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 0011010x
                                xor_imm_to_regmem_or_acc();
                            }
                        } else { // ---------------------------------------- 001100xx
                            xor_regmem_and_reg_to_either();
                        }
                    }
                } else { // ------------------------------------------------ 0010xxxx
                    if(b4) { // --------------------------------------------- 00101xxx
                        if(b5) { // ----------------------------------------- 001011xx
                            if(b6) { // ------------------------------------- 0010111x
                                if(b7) { // --------------------------------- 00101111
                                    cmp_das();
                                } else { // -------------------------------- 00101110
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 0010110x
                                sub_imm_from_acc();
                            }
                        } else { // ---------------------------------------- 001010xx
                            sub_regmem_and_reg_to_either();
                        }
                    } else { // -------------------------------------------- 00100xxx
                        if(b5) { // ----------------------------------------- 001001xx
                            if(b6) { // ------------------------------------- 0010011x
                                if(b7) { // --------------------------------- 00100111
                                    inc_daa();
                                } else { // -------------------------------- 00100110
                                    __debugbreak();
                                }
                            } else { // ------------------------------------ 0010010x
                                and_imm_to_acc();
                            }
                        } else { // ---------------------------------------- 001000xx
                            and_regmem_with_reg_to_either();
                        }
                    }
                }
            } else { // ---------------------------------------------------- 000xxxxx
                // special case where we must check the last 3 bits for a couple patterns
                switch(byte & 0b00000111) {
                    case 0b110: {
                        push_seg();

                    }break;
                    case 0b111:{
                        pop_seg();
                    }break;
                    default:{
                        if(b3) { // ------------------------------------------------- 0001xxxx
                            if(b4) { // --------------------------------------------- 00011xxx
                                if(b5) { // ----------------------------------------- 000111xx
                                    if(b6) { // ------------------------------------- 0001111x
                                        if(b7) { // --------------------------------- 00011111
                                            __debugbreak();
                                        } else { // -------------------------------- 00011110
                                            __debugbreak();
                                        }
                                    } else { // ------------------------------------ 0001110x
                                        sbb_imm_from_acc();
                                    }
                                } else { // ---------------------------------------- 000110xx
                                    sbb_regmem_from_reg_to_either();
                                }
                            } else { // -------------------------------------------- 00010xxx
                                if(b5) { // ----------------------------------------- 000101xx
                                    if(b6) { // ------------------------------------- 0001011x
                                        if(b7) { // --------------------------------- 00010111
                                            __debugbreak();
                                        } else { // -------------------------------- 00010110
                                            __debugbreak();
                                        }
                                    } else { // ------------------------------------ 0001010x
                                        adc_imm_to_acc();
                                    }
                                } else { // ---------------------------------------- 000100xx
                                    adc_regmem_w_reg_to_either();
                                }
                            }
                        } else { // ------------------------------------------------ 0000xxxx
                            if(b4) { // --------------------------------------------- 00001xxx
                                if(b5) { // ----------------------------------------- 000011xx
                                    if(b6) { // ------------------------------------- 0000111x
                                        if(b7) { // --------------------------------- 00001111
                                            __debugbreak();
                                        } else { // -------------------------------- 00001110
                                            __debugbreak();
                                        }
                                    } else { // ------------------------------------ 0000110x
                                        if(b7) { // --------------------------------- 00001101
                                            __debugbreak();
                                        } else { // -------------------------------- 00001100
                                            __debugbreak();
                                        }
                                    }
                                } else { // ---------------------------------------- 000010xx
                                    if(b6) { // ------------------------------------- 0000101x
                                        if(b7) { // --------------------------------- 00001011
                                            __debugbreak();
                                        } else { // -------------------------------- 00001010
                                            __debugbreak();
                                        }
                                    } else { // ------------------------------------ 0000100x
                                        if(b7) { // --------------------------------- 00001001
                                            __debugbreak();
                                        } else { // -------------------------------- 00001000
                                            __debugbreak();
                                        }
                                    }
                                }
                            } else { // -------------------------------------------- 00000xxx
                                if(b5) { // ----------------------------------------- 000001xx
                                    if(b6) { // ------------------------------------- 0000011x
                                        if(b7) { // --------------------------------- 00000111
                                            __debugbreak();
                                        } else { // -------------------------------- 00000110
                                            __debugbreak();
                                        }
                                    } else { // ------------------------------------ 0000010x
                                        add_imm_to_acc();
                                    }
                                } else { // ---------------------------------------- 000000xx
                                    add_regmem_w_reg_to_either();
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

int main() {
    FILE* file = fopen("computer_enhance/perfaware/part1/listing_0042_completionist_decode","rb");
    if(!file) {
        printf("couldn't open file.");
    }

    // Determine the file size
    fseek(file, 0, SEEK_END);
    u64 file_size = ftell(file);
    rewind(file);

    stream = (u8*)malloc(file_size);
    if (!stream) {
        printf("Failed to allocate memory for the buffer.\n");
        fclose(file);
        return 1;
    }

    size_t result = fread(stream, 1, file_size, file);
    if (result != file_size) {
        printf("Failed to read the file.\n");
        fclose(file);
        free(stream);
        return 1;
    }

    decode();
}